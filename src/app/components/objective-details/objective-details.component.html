<h2 class="drawer-title">{{ objective.name }}</h2>

<div class="drawer-content">
  <small
    *ngIf="objective.description"
    [ngClass]="{'description-truncate': descriptionTruncate}"
    (click)="descriptionTruncate = !descriptionTruncate"
    class="description"
  >
    {{ objective.description }}
  </small>
</div>

<div class="drawer-content" fxLayout fxLayoutGap="8px">
  <div fxLayout="column" fxLayoutGap="8px" fxLayoutAlign="center center" fxFlexAlign="start">
    <small>Responsável</small>
    <div [matTooltip]="objective.owner!.name" matTooltipPosition="above">
      <img
        *ngIf="objective.owner!.photo; else noPhoto"
        [src]="objective.owner!.photo"
        [alt]="objective.owner!.name"
        class="user-photo user-photo-md"
      />
      <ng-template #noPhoto>
        <mat-icon class="user-photo user-photo-md">
          person
        </mat-icon>
      </ng-template>
    </div>
  </div>
  <mat-divider [vertical]="true" />
  <div fxFlex fxLayout="column" fxLayoutGap="8px">
    <small>Apoiadores</small>
    <div *ngIf="supporters && supporters.length > 0, else noSupporters" class="supporters">
      <div *ngFor="let supporter of supporters" class="supporter">
        <div [matTooltip]="supporter.name" matTooltipPosition="above">
          <img
            *ngIf="supporter.photo, else noPhoto"
            [src]="supporter.photo"
            class="user-photo user-photo-md"
          />
          <ng-template #noPhoto>
            <mat-icon class="user-photo user-photo-md">
              person
            </mat-icon>
          </ng-template>
        </div>
      </div>
    </div>
    <ng-template #noSupporters>
      <span class="no-supporters">Nenhum colaborador cadastrado.</span>
    </ng-template>
  </div>
</div>

<mat-divider />

<div class="drawer-content chart">
  <div class="chart-donut">
    <mat-progress-spinner
      class="chart-donut-progress"
      mode="determinate"
      diameter="48"
      [ngClass]="getProgressStatus(objective) | ColorProgress"
      [value]="objective.conclusionPercent"
    />
    <span class="chart-donut-value">
      {{ objective.conclusionPercent ? (objective.conclusionPercent / 100 | percent: '1.0-1') : '0%' }}
    </span>
  </div>
  <div class="chart-resume">
    <div>Percentual de conclusão</div>
    <small [matTooltip]="'Prazo: ' + (objective.deadline | date: 'dd/MM/yyyy')" matTooltipPosition="above">
      Restam {{ daysToEnd(objective.deadline) }} dias
    </small>
  </div>
</div>

<mat-divider />

<div class="drawer-content">

  <div
    *ngIf="loadingKrs, else noLoadingKrs"
    fxLayout
    fxLayoutAlign="center center"
    style="margin: 40px 0;"
  >
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <ng-template #noLoadingKrs>
    <div class="krs">

      <div class="krs-header">
        <div *ngIf="krs && krs.length > 0, else noResults">
          {{krs.length}} KR{{krs.length > 1 ? 's' : ''}} encontrado{{krs.length > 1 ? 's' : ''}}
        </div>
        <ng-template #noResults>
          Nenhum KR cadastrado
        </ng-template>
        <button (click)="createKR(objective)" mat-flat-button color="primary">
          <mat-icon>add</mat-icon> CRIAR KR
        </button>
      </div>

      <ul *ngIf="krs && krs.length > 0" class="krs-list">
        <li *ngFor="let kr of krs; let i = index">
          <div [matTooltip]="kr.owner!.name" matTooltipPosition="above">
            <img
              *ngIf="kr.owner!.photo; else noPhoto"
              [src]="kr.owner!.photo"
              [alt]="kr.owner!.name"
              class="user-photo user-photo-xs"
            />
            <ng-template #noPhoto>
              <mat-icon class="user-photo user-photo-xs">
                person
              </mat-icon>
            </ng-template>
          </div>
          <div class="krs-list-content">
            <p class="krs-list-name">
              {{ kr.name }}
              <mat-icon *ngIf="kr.description" [matTooltip]="kr.description" matTooltipPosition="above">
                info
              </mat-icon>
            </p>
            <div class="krs-list-actions">
              <mat-slider
                class="krs-list-slider"
                [ngClass]="{
                  'no-slider-thumb': kr.type === 'task' || kr.type === 'value',
                  'block-slider': isMobile && (!unblockSlider[i] || unblockSlider[i] === false)
                }"
              >
                <input
                  matSliderThumb
                  [(ngModel)]="kr.progress"
                  (mousedown)="getCurrentProgress(kr)"
                  (dragStart)="getCurrentProgress(kr)"
                  (dragEnd)="blockSlider(i)"
                  (change)="updateProgress(kr)"
                  [disabled]="kr.type === 'task' || kr.type === 'value'"
                  min="0"
                  max="100"
                >
                <div *ngIf="isMobile" class="click-to-slider" (click)="unblockSlider[i] = true">
                  Alterar
                </div>
              </mat-slider>
              <div class="krs-list-actions-progress">
                {{ kr.progress / 100 | percent: '1.0-1' }}
              </div>

              <button
                (click)="openEditKr(kr)"
                mat-icon-button
                matTooltip="Editar KR"
                matTooltipPosition="above"
                aria-label="Editar KR"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                (click)="deleteKr(kr)"
                mat-icon-button
                matTooltip="Excluir KR"
                matTooltipPosition="above"
                aria-label="Excluir KR"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
            <div *ngIf="kr.type === 'value' && kr.value" fxLayout fxLayoutAlign="center center" fxLayoutGap="8px">
              <mat-form-field fxFlex="50%">
                <mat-label>Informe um valor</mat-label>
                <input
                  [(ngModel)]="kr.valued"
                  (ngModelChange)="updateValue(kr)"
                  (focus)="getCurrentValue(kr)"
                  name="valued"
                  #valuedField="ngModel"
                  mask="separator.2"
                  thousandSeparator="."
                  decimalMarker=","
                  matInput
                >
                <mat-error *ngIf="valuedField.invalid">
                  <span *ngIf="valuedField.errors?.['required']">Campo obrigatório</span>
                </mat-error>
              </mat-form-field>
              <div fxFlex="50%">
                Meta: <strong>{{ kr.value | mask: 'separator.2': {thousandSeparator: '.', decimalMarker: ','} }}</strong>
                <br>
                <small>({{ kr.unit }})</small>
              </div>
            </div>
            <div *ngIf="kr.tasks && kr.tasks.length > 0" class="krs-list-tasks">
              <div class="krs-list-tasks-title">
                <small>{{kr.tasks.length}} tarefa{{kr.tasks.length > 1 ? 's' : ''}}</small>
              </div>
              <div *ngFor="let task of kr.tasks" class="krs-list-tasks-checkbox">
                <mat-checkbox
                  [checked]="task.checked"
                  [(ngModel)]="task.checked"
                  (mousedown)="getCurrentProgress(kr)"
                  (ngModelChange)="updateTasks(kr, task)"
                >
                  {{ task.name }}
                </mat-checkbox>
              </div>
            </div>
          </div>
        </li>
      </ul>

    </div>
  </ng-template>

</div>
